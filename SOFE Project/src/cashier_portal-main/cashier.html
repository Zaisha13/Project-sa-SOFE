<!-- cashier.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jessie Cane Juicebar Branch Dashboard</title>

  <link rel="stylesheet" href="cashier.css">
</head>
<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Main Navigation">
      <div>
        <div class="brand">
          <!-- Logo -->
          <img src="logo.png" alt="Jessie Cane Logo" onerror="this.style.display='none'">
          <div>
            <h1>Jessie Cane Juicebar</h1>
            <p style="font-size:12px;">Branch Dashboard</p>
          </div>
        </div>

        <nav class="nav" id="nav">
          <a href="#orders" class="active" data-target="orders"><i class="fa-solid fa-list-check"></i><span>Order Management</span></a>
          <a href="#inventory" data-target="inventory"><i class="fa-solid fa-boxes-stacked"></i><span>Inventory Management</span></a>
          <a href="#reports" data-target="reports"><i class="fa-solid fa-chart-line"></i><span>Sales Reporting</span></a>
          <a href="#receipts" data-target="receipts"><i class="fa-solid fa-receipt"></i><span>Receipts</span></a>
          <a href="#customers" data-target="customers"><i class="fa-solid fa-people-group"></i><span>Customer Handling</span></a>
          <a href="#notifications" data-target="notifications"><i class="fa-solid fa-bell"></i><span>Notifications</span></a>
          <a href="#discounts" data-target="discounts"><i class="fa-solid fa-tags"></i><span>Discounts / Promos</span></a>
        </nav>
      </div>

      <div class="bottom">
        <div style="display:flex;gap:10px;align-items:center;flex-direction:column;">
          <div style="font-size:12px;color:var(--muted);text-align:center;">
            Signed in as <strong style="color:var(--green-700)" id="cashier-name">Cashier User</strong>
          </div>
          <button class="logout-btn" id="logoutBtn">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </button>
        </div>
      </div>
    </aside>

    <!--MAIN CONTENT-->
    <main class="main">
      <header class="topbar">
        <div class="page-title">
          <h2>Jessie Cane Juicebar Branch Dashboard</h2>
          <p class="muted">Restricted Access • Manage orders, inventory, and reports</p>
        </div>

        <div class="controls right">
          <input class="search-input" placeholder="Search orders, customers..." id="searchInput" />
          <button class="btn btn--primary small" id="newItemBtn"><i class="fa-solid fa-plus"></i> New</button>
        </div>
      </header>

      <section class="grid">

        <!--Orders Card-->
        <div class="card col-8" id="orders">
          <h3>Order Management</h3>
          <p class="muted">Approve/cancel orders, update status.</p>

          <table style="margin-top:14px;">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Drink(s)</th>
                <th>Size</th>
                <th>Special Instruction</th>
                <th>Status</th>
                <th>Actions</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="ordersTbody">
              <tr id="no-orders" style="display:none;">
                <td colspan="8" class="muted">No orders available.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Inventory -->
        <div class="card col-6" id="inventory" style="margin-top:6px;">
          <h3>Inventory Management</h3>
          <p class="muted">Stock-in/out, auto/manual updates, branch reports.</p>

          <table style="margin-top:12px;">
            <thead>
              <tr><th>Item</th><th>Stock Level</th><th>Actions</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Pure Sugarcane</td>
                <td>50</td>
                <td>
                  <button class="btn btn--outline small" onclick="stockIn('Pure Sugarcane')">Stock In</button>
                  <button class="btn btn--outline small" onclick="stockOut('Pure Sugarcane')">Stock Out</button>
                </td>
              </tr>
              <tr>
                <td>Lemon Cane</td>
                <td>32</td>
                <td>
                  <button class="btn btn--outline small" onclick="stockIn('Lemon Cane')">Stock In</button>
                  <button class="btn btn--outline small" onclick="stockOut('Lemon Cane')">Stock Out</button>
                </td>
              </tr>
            </tbody>
          </table>

          <div style="margin-top:12px;">
            <button class="btn btn--primary small" onclick="generateReport()"><i class="fa-solid fa-file-lines"></i> Generate Branch Report</button>
          </div>
        </div>

        <!-- Reports -->
        <div class="card col-6" id="reports" style="margin-top:6px;">
          <h3>Sales Reporting</h3>
          <p class="muted">Daily summary reports.</p>

          <div style="display:flex;align-items:center;gap:12px;margin-top:12px;">
            <div>
              <div style="font-size:28px;font-weight:800;color:var(--green-700)"><span id="total-sales"></span>₱0.00</span></div>
              <div class="muted">Total Sales Today</div>
              <div style="margin-top:8px; font-size:13px; color:var(--muted)">
                Orders: <strong id="total-orders">0</strong>
                &nbsp;•&nbsp; Pending: <strong id="pending-orders">0</strong>
                &nbsp;•&nbsp; Approved: <strong id="approved-orders">0</strong>
              </div>
            </div>
            <div class="right">
              <button class="btn btn--primary small" onclick="viewDetailedReport()"><i class="fa-solid fa-chart-pie"></i> View Detailed Report</button>
            </div>
          </div>
        </div>

        <!-- Receipts -->
        <div class="card col-4" id="receipts" style="margin-top:6px;">
          <h3>Receipts</h3>
          <p class="muted">Email online receipts to customers.</p>

          <form style="margin-top:12px;" id="receiptForm">
            <label class="muted" for="email">Customer Email:</label>
            <input id="email" type="email" placeholder="Enter email" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); margin-top:6px;" required />
            <button class="btn btn--primary" type="submit" style="margin-top:10px;"><i class="fa-solid fa-envelope"></i> Send Receipt</button>
          </form>
        </div>

        <!-- Customers -->
        <div class="card col-8" id="customers" style="margin-top:6px;">
          <h3>Customer Handling</h3>
          <p class="muted">View basic customer info.</p>

          <table style="margin-top:12px;">
            <thead>
              <tr><th>Name</th><th>Email</th><th>Phone</th></tr>
            </thead>
            <tbody>
              <tr><td>Rudge Lompon</td><td>rudge@example.com</td><td>123-456-7890</td></tr>
              <tr><td>Simon Cruz</td><td>simon@example.com</td><td>098-765-4321</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Notifications -->
        <div class="card col-6" id="notifications" style="margin-top:6px;">
          <h3>Notifications</h3>
          <p class="muted">Receive from Super Admin, send updates to customers.</p>

          <p style="margin-top:8px;">Latest Notification: <strong>Inventory low on apples.</strong></p>
          <form style="margin-top:10px;" id="notificationForm">
            <label class="muted" for="message">Send Update:</label>
            <input id="message" type="text" placeholder="Enter message" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); margin-top:6px;" required />
            <button class="btn btn--primary" type="submit" style="margin-top:10px;"><i class="fa-solid fa-paper-plane"></i> Send to Customers</button>
          </form>
        </div>

        <!-- Discounts -->
        <div class="card col-6" id="discounts" style="margin-top:6px;">
          <h3>Discounts / Promos</h3>
          <p class="muted">Apply only those set by Super Admin.</p>
          <p style="margin-top:8px;">Current Promo: <strong>10% off on all juices.</strong></p>
          <button class="btn btn--primary small" onclick="applyPromo()" style="margin-top:8px;"><i class="fa-solid fa-tag"></i> Apply to Order</button>
        </div>

      </section>
    </main>

  </div>

  <script src="customer_portal-main/popup.js"></script>
  <script src="cashier.js"></script>
      try {
        initializeData();
        loadOrders();
        // loadInventory and loadCustomers are optional but we'll attempt if available
        if (typeof loadInventory === 'function') loadInventory();
        if (typeof loadCustomers === 'function') loadCustomers();
      } catch (err) {
        console.warn('Initialization error (some functions may be missing):', err);
      }
    });

    // Simple single-page show/hide behavior driven by sidebar links
    document.querySelectorAll('.nav a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        // set active state
        document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');

        const target = this.dataset.target;
        if (!target) return;

        // Scroll to the section within main content
        const section = document.getElementById(target);
        if (section) {
          const topOffset = section.getBoundingClientRect().top + window.scrollY - 80;
          window.scrollTo({ top: topOffset, behavior: 'smooth' });
        }
      });
    });

    // Order Management Functions with Popups
function approveOrder(orderId) {
    const orders = JSON.parse(localStorage.getItem("jessie_orders") || "[]");
    const sales = JSON.parse(localStorage.getItem("jessie_sales") || "{}");
    
    const orderIndex = orders.findIndex(order => order.id === orderId);
    if (orderIndex !== -1 && orders[orderIndex].status === 'pending') {
        // Update order status
        orders[orderIndex].status = 'approved';
        localStorage.setItem("jessie_orders", JSON.stringify(orders));
        
        // Update sales data
        const orderTotal = orders[orderIndex].total;
        sales.totalSales = (sales.totalSales || 0) + orderTotal;
        sales.totalOrders = (sales.totalOrders || 0) + 1;
        sales.approvedOrders = (sales.approvedOrders || 0) + 1;
        sales.pendingOrders = Math.max(0, (sales.pendingOrders || 1) - 1);
        
        localStorage.setItem("jessie_sales", JSON.stringify(sales));
        
        // Update inventory (reduce stock for each item)
        updateInventoryForOrder(orders[orderIndex]);
        
        // Reload all data
        loadOrders();
        loadInventory();
        loadCustomers();
        
        showToast('success', 'Order Approved!', `Order #${orderId} has been approved and sales updated.`);
    }
}

    function cancelOrder(orderId) {
  const orders = JSON.parse(localStorage.getItem("jessie_orders") || "[]");
  const sales = JSON.parse(localStorage.getItem("jessie_sales") || "{}");
  const orderIndex = orders.findIndex(order => order.id === orderId);

  if (orderIndex === -1) return;

  // Only allow cancelling pending orders via confirmation
  if (orders[orderIndex].status !== 'pending') {
    showToast('info', 'Cannot Cancel', 'Only pending orders can be cancelled.');
    return;
  }

  showPopup('warning', {
    title: 'Confirm Delete',
    message: `Are you sure you want to delete Order #${orderId}? This will remove the entire order.`,
    actions: [
      {
        text: 'No',
        type: 'secondary',
        handler: hidePopup
      },
      {
        text: 'Yes, Delete',
        type: 'primary',
        handler: () => {
          // Remove the order
          orders.splice(orderIndex, 1);
          localStorage.setItem("jessie_orders", JSON.stringify(orders));

          // Update pending count
          sales.pendingOrders = Math.max(0, (sales.pendingOrders || 1) - 1);
          localStorage.setItem("jessie_sales", JSON.stringify(sales));

          loadOrders();
          loadCustomers();

          hidePopup();
          showToast('warning', 'Order Deleted', `Order #${orderId} has been deleted.`);
        }
      }
    ]
  });
}

    function stockIn(item) {
      showPopup('info', {
        title: 'Stock In',
        message: `Enter quantity to stock in for ${item}:`,
        actions: [
          {
            text: 'Cancel',
            type: 'secondary',
            handler: hidePopup
          },
          {
            text: 'Confirm Stock In',
            type: 'primary',
            handler: () => {
              showToast('success', 'Stock Updated', `${item} stock has been increased.`);
              hidePopup();
            }
          }
        ]
      });
    }

    function stockOut(item) {
      showPopup('warning', {
        title: 'Stock Out',
        message: `Enter quantity to stock out for ${item}:`,
        actions: [
          {
            text: 'Cancel',
            type: 'secondary',
            handler: hidePopup
          },
          {
            text: 'Confirm Stock Out',
            type: 'primary',
            handler: () => {
              showToast('info', 'Stock Updated', `${item} stock has been decreased.`);
              hidePopup();
            }
          }
        ]
      });
    }

    function generateReport() {
      showPopup('success', {
        title: 'Generate Report',
        message: 'Branch report is being generated. This may take a few moments...',
        actions: [
          {
            text: 'Download Report',
            type: 'primary',
            handler: () => {
              showToast('success', 'Report Generated', 'Branch report downloaded successfully!');
              hidePopup();
            }
          }
        ]
      });
    }

    function viewOrderDetails(orderId) {
    const orders = JSON.parse(localStorage.getItem("jessie_orders") || "[]");
    const order = orders.find(o => o.id === orderId);
    
    if (order) {
        let details = `Order #${order.id}\n`;
        details += `Customer: ${order.customerName}\n`;
        details += `Phone: ${order.customerPhone}\n`;
        details += `Date: ${order.date} ${order.time}\n`;
        details += `Status: ${order.status.toUpperCase()}\n\n`;
        details += 'Items:\n';
        
        order.items.forEach(item => {
            details += `- ${item.qty}x ${item.name} (${item.size})`;
            if (item.special !== 'None') {
                details += ` - ${item.special}`;
            }
            if (item.notes) {
                details += ` - Notes: ${item.notes}`;
            }
            details += `: ₱${(item.price * item.qty).toFixed(2)}\n`;
        });
        
        details += `\nSubtotal: ₱${order.subtotal.toFixed(2)}\n`;
        details += `Tax: ₱${order.tax.toFixed(2)}\n`;
        details += `Total: ₱${order.total.toFixed(2)}\n`;
        
        if (order.customerNotes) {
            details += `\nCustomer Notes: ${order.customerNotes}`;
        }
        
        alert(details);
    }
}

function initializeData() {
    // Initialize sales data if not exists
    if (!localStorage.getItem("jessie_sales")) {
        const initialSales = {
            totalSales: 0,
            totalOrders: 0,
            pendingOrders: 0,
            approvedOrders: 0,
            lastReset: new Date().toISOString()
        };
        localStorage.setItem("jessie_sales", JSON.stringify(initialSales));
    }

    // Initialize inventory if not exists
    if (!localStorage.getItem("jessie_inventory")) {
        const initialInventory = [
            { name: "Pure Sugarcane", stock: 50 },
            { name: "Calamansi Cane", stock: 32 },
            { name: "Lemon Cane", stock: 45 },
            { name: "Yakult Cane", stock: 28 },
            { name: "Lychee Cane", stock: 35 }
        ];
        localStorage.setItem("jessie_inventory", JSON.stringify(initialInventory));
    }
    
    // Initialize orders if not exists (empty array)
    if (!localStorage.getItem("jessie_orders")) {
        localStorage.setItem("jessie_orders", JSON.stringify([]));
    }
}

function loadOrders() {
    const orders = JSON.parse(localStorage.getItem("jessie_orders") || "[]");
    const sales = JSON.parse(localStorage.getItem("jessie_sales") || "{}");
    const tbody = document.getElementById("ordersTbody");
    const noOrders = document.getElementById("no-orders");

    tbody.innerHTML = '';

    if (orders.length === 0) {
        noOrders.style.display = 'block';
    } else {
        noOrders.style.display = 'none';
        
    // Sort orders by date/time (oldest first) so we can assign sequential order numbers
    const sortedOrders = orders.slice().sort((a, b) => {
      const dateA = new Date(a.date + ' ' + a.time);
      const dateB = new Date(b.date + ' ' + b.time);
      return dateA - dateB;
    });

  // Helper to pad display order numbers like 001
  function padNumber(n, width = 3) {
    const s = String(n);
    return s.padStart(width, '0');
  }

  // Render newest at top while keeping a stable ordinal for order IDs
  const renderList = sortedOrders.slice().reverse(); // newest first for UI

    renderList.forEach((order, idx) => {
      // defensive defaults
      order.items = Array.isArray(order.items) ? order.items : [];
    // Compute display id using the position in the chronological sorted list
    // Find chronological index (1-based)
  const chronoIndexRaw = sortedOrders.findIndex(o => o.id === order.id);
  const chronoIndex = chronoIndexRaw === -1 ? null : chronoIndexRaw + 1;
  const displayId = chronoIndex ? padNumber(chronoIndex, 3) : (order.id || '---');
    const tr = document.createElement('tr');

      // Prepare per-column values
      const drinksList = order.items.map(i => `${i.qty}x ${i.name}`).join('<br>');
      const sizesList = order.items.map(i => `${i.size} ${i.qty ? '×' + i.qty : ''}`).join('<br>');
      const specialList = order.items.map(i => {
          let s = i.special && i.special !== 'None' ? i.special : '';
          if (i.notes) s = (s ? s + ' • ' : '') + `Notes: ${i.notes}`;
          return s || '-';
      }).join('<br>');

      const orderLevelNotes = order.customerNotes && order.customerNotes.trim() !== ''
            ? `<div style="margin-top:6px; font-style:italic; color:#666;">Customer Notes: ${order.customerNotes}</div>`
            : '';

      tr.innerHTML = `
  <td>${displayId}</td>
        <td>
          <strong>${order.customerName}</strong><br>
          <small class="muted">${order.customerPhone}</small>
        </td>
        <td>${drinksList}${orderLevelNotes}</td>
        <td>${sizesList}</td>
        <td>${specialList}</td>
        <td>
          <span class="badge ${order.status === 'pending' ? 'badge-pending' : 'badge-approved'}">
            ${order.status.toUpperCase()}
          </span>
        </td>
        <td>
          ${order.status === 'pending' ? `
            <button class="action-btn action-approve" onclick="approveOrder('${order.id}')">Approve</button>
            <button class="action-btn action-cancel" onclick="cancelOrder('${order.id}')">Cancel</button>
          ` : `
            <span class="muted">Completed</span>
          `}
          <button class="action-btn action-cancel" onclick="viewOrderDetails('${order.id}')" style="margin-left: 5px;">
            <i class="fa-solid fa-eye"></i>
          </button>
        </td>
        <td>₱${(Number(order.total) || 0).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
    }

    // Update sales stats
    updateSalesStats(orders, sales);
}

// Update sales stats function
function updateSalesStats(orders, sales) {
    const pendingOrders = orders.filter(order => order.status === 'pending').length;
    const approvedOrders = orders.filter(order => order.status === 'approved').length;
    
    // Update the sales object with current counts
    sales.pendingOrders = pendingOrders;
    sales.approvedOrders = approvedOrders;
    sales.totalOrders = orders.length;
    
    // Save updated sales data
    localStorage.setItem("jessie_sales", JSON.stringify(sales));
    
    document.getElementById('total-sales').textContent = `₱${(sales.totalSales || 0).toFixed(2)}`;
    document.getElementById('total-orders').textContent = sales.totalOrders || 0;
    document.getElementById('pending-orders').textContent = pendingOrders;
    document.getElementById('approved-orders').textContent = approvedOrders;
}

// Auto-refresh when orders/sales change in another tab/window (or customer page)
window.addEventListener('storage', (e) => {
  if (!e.key) return;
  if (e.key === 'jessie_orders' || e.key === 'jessie_sales') {
    try {
      loadOrders();
      // read latest sales object and update UI
      const salesObj = JSON.parse(localStorage.getItem('jessie_sales') || '{}');
      const ordersObj = JSON.parse(localStorage.getItem('jessie_orders') || '[]');
      updateSalesStats(ordersObj, salesObj);
    } catch (err) {
      console.error('Error refreshing data from storage event:', err);
    }
  }
});

    function viewDetailedReport() {
      showPopup('info', {
        title: 'Detailed Sales Report',
        message: 'Loading detailed sales analytics and charts...',
        actions: [
          {
            text: 'View Charts',
            type: 'primary',
            handler: () => {
              showToast('info', 'Report Opened', 'Detailed sales report is now displayed.');
              hidePopup();
            }
          }
        ]
      });
    }

    function applyPromo() {
      showPopup('success', {
        title: 'Apply Promotion',
        message: '10% discount will be applied to the selected order.',
        actions: [
          {
            text: 'Apply Discount',
            type: 'primary',
            handler: () => {
              showToast('success', 'Promo Applied', '10% discount has been applied to the order!');
              hidePopup();
            }
          }
        ]
      });
    }

    // Form Submissions with Popups
    document.getElementById('receiptForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      
      showPopup('info', {
        title: 'Send Receipt',
        message: `Sending receipt to ${email}...`,
        actions: [
          {
            text: 'Send Receipt',
            type: 'primary',
            handler: () => {
              showToast('success', 'Receipt Sent', `Receipt has been sent to ${email}`);
              this.reset();
              hidePopup();
            }
          }
        ]
      });
    });

    document.getElementById('notificationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const message = document.getElementById('message').value;
      
      showPopup('warning', {
        title: 'Send Notification',
        message: `Are you sure you want to send this notification to all customers?\n\n"${message}"`,
        actions: [
          {
            text: 'Cancel',
            type: 'secondary',
            handler: hidePopup
          },
          {
            text: 'Send to All Customers',
            type: 'primary',
            handler: () => {
              showToast('success', 'Notification Sent', 'Message has been sent to all customers');
              this.reset();
              hidePopup();
            }
          }
        ]
      });
    });

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      showPopup('warning', {
        title: 'Confirm Logout',
        message: 'Are you sure you want to log out from the cashier dashboard?',
        actions: [
          {
            text: 'Cancel',
            type: 'secondary',
            handler: hidePopup
          },
          {
            text: 'Log Out',
            type: 'primary',
            handler: () => {
              localStorage.removeItem("isLoggedIn");
              localStorage.removeItem("currentUser");
              showToast('success', 'Logged Out', 'You have been successfully logged out.');
              setTimeout(() => {
                window.location.href = "customer_portal-main/login.html";
              }, 1500);
            }
          }
        ]
      });
    });

    // Quick New button
    document.getElementById('newItemBtn').addEventListener('click', function() {
      showPopup('info', {
        title: 'Create New',
        message: 'What would you like to create?',
        actions: [
          {
            text: 'New Order',
            type: 'primary',
            handler: () => {
              showToast('info', 'New Order', 'Opening new order form...');
              hidePopup();
            }
          },
          {
            text: 'New Customer',
            type: 'primary',
            handler: () => {
              showToast('info', 'New Customer', 'Opening customer registration...');
              hidePopup();
            }
          }
        ]
      });
    });

    // Basic search (demo)
    document.getElementById('searchInput').addEventListener('input', function(e) {
      if (e.target.value.length > 2) {
        showToast('info', 'Searching...', `Searching for "${e.target.value}"`);
      }
    });

    // Initialize with welcome message
    setTimeout(() => {
      const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
      if (currentUser.name) {
        showToast('success', 'Cashier Dashboard', `Welcome back, ${currentUser.name}!`);
      }
    }, 1000);

  </script>
  
</body>
</html>